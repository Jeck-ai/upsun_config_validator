applications:
  web:
    type: nodejs@18
    hooks:
      build: |
        npm install
        npm run build
    web:
      commands:
        start: npm run start:prod
      locations:
        "/assets":
          root: "dist/assets"
          expires: 1y
          allow: true
    mounts:
      "/uploads":
        source: storage
        source_path: uploads

  worker:
    type: nodejs@18
    commands:
      start: npm run worker

services:
  db:
    type: postgresql:15
  cache:
    type: redis:7.0
  varnish:
    type: varnish:6.0
    configuration:
      vcl: |
        sub vcl_recv {
          # Default VCL
          set req.backend_hint = web.backend();
        }

routes:
  "https://{default}/":
    type: upstream
    upstream: "web"